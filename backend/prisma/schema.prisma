// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // ADMIN, GUARDIAN, VENDOR (Student removed - not a user)
  description String?
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("roles")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String?
  roleId       String
  role         Role     @relation(fields: [roleId], references: [id])
  phone        String?
  isVerified   Boolean  @default(false)

  wallets          Wallet[]
  sentTransactions Transaction[] @relation("Sender")
  walletRules      WalletRule[]

  // Guardian's students (separate entity, not User)
  students         Student[]

  auditLogs        AuditLog[]
  tasks            TaskChecklist[]
  vendorProfile    Vendor?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("users")
}

// Student is NOT a user - No login, only has PIN for vendor transactions
model Student {
  id           String   @id @default(uuid())
  name         String
  studentId    String   @unique  // College ID / Roll Number
  pinHash      String            // Hashed 4-6 digit PIN for vendor transactions

  guardianId   String
  guardian     User     @relation(fields: [guardianId], references: [id])

  wallet       Wallet?

  status       String   @default("ACTIVE")  // ACTIVE, BLOCKED

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("students")
}

model Vendor {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  storeName   String
  description String?
  approved    Boolean  @default(false)

  menuItems   MenuItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("vendors")
}

model Wallet {
  id          String   @id @default(uuid())
  type        String   // GUARDIAN, STUDENT, VENDOR
  balance     Decimal  @default(0.0)
  currency    String   @default("INR")

  // For Guardian/Vendor wallets
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])

  // For Student wallets
  studentId   String?  @unique
  student     Student? @relation(fields: [studentId], references: [id])

  sentTransactions     Transaction[] @relation("WalletSender")
  receivedTransactions Transaction[] @relation("WalletReceiver")
  rules                WalletRule[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("wallets")
}

model WalletRule {
  id              String   @id @default(uuid())
  walletId        String
  wallet          Wallet   @relation(fields: [walletId], references: [id])
  dailyLimit      Decimal?
  allowedVendors  String   // JSON string or comma separated for SQLite
  active          Boolean  @default(true)
  createdByUserId String?
  createdBy       User?    @relation(fields: [createdByUserId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("wallet_rules")
}

model Transaction {
  id           String   @id @default(uuid())
  fromWalletId String?
  toWalletId   String?
  fromWallet   Wallet?  @relation("WalletSender", fields: [fromWalletId], references: [id])
  toWallet     Wallet?  @relation("WalletReceiver", fields: [toWalletId], references: [id])

  amount       Decimal
  type         String   // DEPOSIT, TRANSFER, PAYMENT, WITHDRAWAL
  status       String   // PENDING, COMPLETED, FAILED, REJECTED
  description  String?

  initiatedByUserId String
  user              User   @relation("Sender", fields: [initiatedByUserId], references: [id])

  items        TransactionItem[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("transactions")
}

// MoneyRequest removed - Students don't interact with system
// Guardian directly adds money to student wallet

model TaskChecklist {
  id          String   @id @default(uuid())
  title       String
  description String?
  role        String   
  status      String   // PENDING, COMPLETED
  
  userId      String?  
  user        User?    @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())
  
  @@map("task_checklists")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  details   String?
  timestamp DateTime @default(now())

  @@map("audit_logs")
}

// Menu items for vendor cafeteria
model MenuItem {
  id          String   @id @default(uuid())
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id])
  name        String
  price       Decimal
  category    String?  // e.g., "Food", "Beverages", "Snacks"
  available   Boolean  @default(true)

  transactionItems TransactionItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("menu_items")
}

// Line items in a transaction (what was purchased)
model TransactionItem {
  id            String   @id @default(uuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  menuItemId    String?
  menuItem      MenuItem?   @relation(fields: [menuItemId], references: [id])
  name          String   // Store name at time of purchase
  price         Decimal  // Store price at time of purchase
  quantity      Int      @default(1)

  createdAt     DateTime @default(now())

  @@map("transaction_items")
}
